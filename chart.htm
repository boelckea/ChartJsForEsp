<!doctype html>
<html>

<head>
    <title>Time Scale Point Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
    <script src="utils.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
<div style="width: 100%;">
    <canvas id="canvas"></canvas>
</div>
<br>
<br>
<button id="zoomIn">Zoom in</button>
<button id="zoomOut">Zoom out</button>
<script>
    var color = Chart.helpers.color;
    var config = {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: "Test Chart"
            },
            elements: {
                point: { radius: 0, hitRadius: 10, hoverRadius: 10 },
                line: { borderWidth: 1 }
            },
            scales: {
                xAxes: [
                    {
                        type: "time",
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Date'
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                var dateval = values[index];
                                if (dateval !== undefined) {
                                    return new Date(values[index].value).toLocaleDateString('de-DE', { day: 'numeric', month: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' });
                                } else {
                                    return "";
                                }
                            },
                            autoSkip: true,
                            maxTicksLimit: 20
                        }
                    }
                ],
                yAxes: [
                    {
                        display: true,
                        beginAtZero: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'value'
                        }
                    }
                ]
            }
        }
    };

    window.onload = function() {
        var colors = [window.chartColors.green, window.chartColors.red, window.chartColors.blue, window.chartColors.green, window.chartColors.grey, window.chartColors.pink];


        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState === XMLHttpRequest.DONE) { // XMLHttpRequest.DONE == 4
                if (xmlhttp.status === 200) {
                    // parse csv data to datasets
                    var dataSplit = xmlhttp.responseText.split("\n");
                    var datasets = [];
                    dataSplit.forEach(function(item, index) {
                        if (index === 0) {
                            // create blank datasets
                            var headerSplit = item.split(";");
                            headerSplit.forEach(function(headeritem, headerindex) {
                                if (headerindex !== 0) {
                                    var dataset = {
                                        label: headeritem,
                                        lineTension: 0,
                                        backgroundColor: color(colors[headerindex]).alpha(0.5).rgbString(),
                                        borderColor: colors[headerindex],
                                        fill: false,
                                        data: []
                                    }
                                    datasets.push(dataset);
                                }
                            });
                            return;
                        }
                        var lineSplit = item.split(";");
                        lineSplit.forEach(function(lineitem, lineindex) {
                            if (lineindex === 0) {
                                return;
                            }
                            datasets[lineindex - 1].data.push(JSON.parse('{"x": ' + lineSplit[0] + ', "y": ' + lineitem + '}'));
                        });
                    });
                    config.data.datasets = datasets;
                    var ctx = document.getElementById("canvas").getContext("2d");
                    window.firstchart = new window.Chart(ctx, config);
                } else if (xmlhttp.status === 400) {
                    alert('There was an error 400');
                } else {
                    alert('something else other than 200 was returned');
                }
            }
        };

        xmlhttp.open("GET", "data.txt?mode=" + getMode() + "&number=" + getNumber(), true);
        xmlhttp.send();
    };

    document.getElementById('zoomIn').addEventListener('click',
        function () {
            var newLocation = "chart.htm?mode=" + getMode() + "&number=" + getNumber() / 10;
            window.location = newLocation;
        });

    document.getElementById('zoomOut').addEventListener('click',
        function () {
            var newLocation = "chart.htm?mode=" + getMode() + "&number=" + getNumber() * 10;
            window.location = newLocation;
        });

    function getMode() {
        var url = new URL(window.location);
        var mode = url.searchParams.get("mode");
        if (mode === null) {
            mode = "last";
        }
        return mode;
    }

    function getNumber() {
        var url = new URL(window.location);
        var number = url.searchParams.get("number");
        if (number === null) {
            number = "3600";
        }
        return number;
    }
</script>
</body>

</html>